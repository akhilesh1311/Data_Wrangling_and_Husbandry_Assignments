---
title: "hw6"
author: "Akhilesh Mahajan"
date: "April 1, 2018"
output: html_document
---
```{r echo = FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(rvest)
library(ggmap)
library(httr)
library(curl)
library(jsonlite)
library(RCurl)
library(stringr)
library(tidytext)
library(grid)
```
1. The weather history on March 7 for the closest (small) airport to Piscataway can be found at   https://www.wunderground.com/history/airport/KSMQ/2018/3/7/DailyHistory.html?req_city=Piscataway&req_state=NJ&req_statename=New+Jersey&reqdb.zip=08854&reqdb.magic=1&reqdb.wmo=99999

   Download (and clean) the table at the bottom of the page, using html_node("#obsTable"), not html_node("table"). Please plot the time of day against temperature and visibility for the day (I suggest using a line and points for each), coloring the point by the amount of precipitation. Because the scales are unrelated, don't put the two data series on the same plot; instead use `facet_wrap()`. Read up on the options for that function to allow the vertical scales to be different. (Alternatively, feel free to try the `patchwork` package, which allows you to combine named plots just by using `+`.)
   

Ans:

```{r}
url <-  "https://www.wunderground.com/history/airport/KSMQ/2018/3/7/DailyHistory.html?req_city=Piscataway&req_state=NJ&req_statename=New+Jersey&reqdb.zip=08854&reqdb.magic=1&reqdb.wmo=99999"
weather <- url %>%
  read_html() %>%
  html_nodes("#obsTable") %>%
  html_table(fill = TRUE)
weather <- weather[[1]]
  
weather_tidy <-
  rename(weather, Time = `Time (EST)`, Temperature = Temp., Precipitation = Precip) %>%
  select(Time, Temperature, Visibility, Precipitation)

weather_tidy$Time <- factor(weather_tidy$Time, levels = weather_tidy$Time)
```

```{r}
#time against temp plot
p1 <- weather_tidy %>% ggplot(aes(Time, Temperature, group = 1, color = Precipitation)) +
  geom_point() +  geom_line() +
  ggtitle("Time Against Temperature")

#time against visibility plot
p2 <- weather_tidy %>% ggplot(aes(Time, Visibility, group = 1, color = Precipitation)) +
  geom_point() +  geom_line() +
  ggtitle("Time Against Visibility")

grid.newpage()
grid.draw(rbind(ggplotGrob(p1), ggplotGrob(p2), size = "last"))
```



2. Look at the API documentation at https://dev.socrata.com/foundry/healthdata.nj.gov/9hse-wixk

Write a function that will use the API and then generate a plot of the rate of heart disease over time by year. Set the default to all races, but include an option to specify the race. To get ggplot2 to generate a plot from within a function, wrap the final object in the print() function. Be sure to include in your RMarkdown a plot, generated by your function, using the default of all races and another using one specific race.

Ans:

```{r}
nj_health_plotter <- function(arg_race = "All") {
  #We get the required data from the url
  nj.health.data <- "https://healthdata.nj.gov/resource/9hse-wixk.json" %>% 
    fromJSON() %>% 
    as.data.frame()
  
  #This is the plotter using the ggplot
  plotter <- nj.health.data %>% filter(nj.health.data$race == arg_race) %>%
    na.omit() %>%
    ggplot(aes(x = year, y = heartdisease, color = race)) + 
    geom_point() + geom_line(aes(group = race)) +
    ggtitle(paste0("Plot of Rate of Heart Disease with year for Race ", arg_race)) + 
    scale_x_discrete("Year") + 
    scale_y_discrete("Hear Rate")
  print(plotter)
}

#default argument
nj_health_plotter()

#specific argument
nj_health_plotter("Asian")
```





3. The New York Times has a nice set of APIs, described at  http://developer.nytimes.com/doc
    a) Get yourself an API key
    b) Make 2 barplots, one with the most common non-stop-words in the titles of the Most Popular articles and another of the most common non-stop-words in the titles of the Top Stores articles.
    c) IMPORTANT: Do not include your api key in your RMarkdown file. Instead, create a file called `api-keys.R`, store the key as a string called `api.key.nytimes`, and include `source("../api-keys.R")` to load the file.


Ans:
```{r}
source("../api-keys.R")
#api.key.nytimes<-c("80752b020a1c448887cc5a8e88f74a94")
ny.result1 <- getForm(
  uri = "http://api.nytimes.com/svc/topstories/v2/home.json",
  apikey = api.key.nytimes
)
ny.result1.df <- ny.result1 %>% 
  fromJSON() %>%
  as.data.frame()

ny.result2 <- getForm(
  uri = "http://api.nytimes.com/svc/mostpopular/v2/mostviewed/all-sections/7.json",
  apikey = api.key.nytimes
)
ny.result2.df <- ny.result2 %>% 
  fromJSON() %>%
  as.data.frame()

```

```{r}
data("stop_words")
ny.result1.df %>% 
  unnest_tokens(results.title.words, results.title) %>%
  anti_join(stop_words, by = c("results.title.words" = "word")) %>% 
  group_by(results.title.words) %>% 
  summarize(count = n()) %>% 
  arrange(-count) %>% 
  head(n = 10) %>%
  ggplot(aes(x = results.title.words, y = count)) +
  ggtitle("Counts of most common words in NY Times Topstories") +
  scale_x_discrete("Words") + 
  scale_y_continuous("Count") +
  geom_col() +
  theme(plot.title = element_text(hjust = 0.5))

```
Here, "Trump" is the most common word.


```{r}
ny.result2.df %>% 
  unnest_tokens(results.title.words, results.title) %>%
  anti_join(stop_words, by = c("results.title.words" = "word")) %>% 
  group_by(results.title.words) %>% 
  summarize(count = n()) %>% 
  arrange(-count) %>% 
  head(n = 10) %>%
  ggplot(aes(x = results.title.words, y = count)) +
  ggtitle("Counts of most common words in NY Times Topstories") +
  scale_x_discrete("Words") + 
  scale_y_continuous("Count") +
  geom_col() +
  theme(plot.title = element_text(hjust = 0.5))
```

As we see, "Trump" is the most common word again.